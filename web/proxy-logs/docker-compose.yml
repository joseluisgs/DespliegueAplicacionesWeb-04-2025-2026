services:

  # ===== NGINX backend escalable =====
  nginx:
    image: ubuntu/nginx
    deploy:
      replicas: 3
    volumes:
      - ./nginx/sites-available:/etc/nginx/sites-available
      - ./nginx/website:/var/www/html
      - ./nginx/logs:/var/log/nginx
    restart: always
    networks:
      - webnet
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ===== Apache backend escalable =====
  apache:
    image: ubuntu/apache2
    deploy:
      replicas: 2
    volumes:
      - ./apache/sites-available:/etc/apache2/sites-available
      - ./apache/website:/var/www/html
      - ./apache/htpasswd/.htpasswd:/etc/apache2/.htpasswd
      - ./apache/logs:/var/log/apache2
    restart: always
    networks:
      - webnet
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ===== NGINX Proxy =====
  proxy:
    image: ubuntu/nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./proxy/conf/nginx.conf:/etc/nginx/nginx.conf
      - ./proxy/certs:/etc/nginx/certs
      - ./proxy/logs:/var/log/nginx
    restart: always
    networks:
      - webnet
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ===== Elasticsearch =====
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.12.0
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
      - xpack.security.enabled=false
    ports:
      - "9200:9200"
    volumes:
      - esdata:/usr/share/elasticsearch/data
    networks:
      - webnet
    restart: always

  # ===== Kibana =====
  kibana:
    image: docker.elastic.co/kibana/kibana:8.12.0
    container_name: kibana
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    ports:
      - "5601:5601"
    volumes:
      - kibana-data:/usr/share/kibana/data
    networks:
      - webnet
    restart: always
    depends_on:
      - elasticsearch

  # ===== Fluentd =====
  fluentd:
    build: ./fluentd
    container_name: fluentd
    ports:
      - "24224:24224"
      - "24224:24224/udp"
    volumes:
      - ./fluentd/fluent.conf:/fluentd/etc/fluent.conf
      - fluentd-buffer:/fluentd/buffer
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
    networks:
      - webnet
    restart: always


# ===== Red de contenedores =====
networks:
  webnet:
    driver: bridge

# ===== Vol√∫menes persistentes =====
volumes:
  esdata:
  kibana-data:
  fluentd-buffer:
  apache-logs:
  nginx-logs:
  proxy-logs:
